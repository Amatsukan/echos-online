<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criação de Personagem - MMORPG</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* (Podes usar um CSS semelhante ao login.html/register.html) */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; margin: 0; background-color: #1a1a1a;
            font-family: sans-serif; color: white;
        }
        .container {
            background-color: #2a2a2a; padding: 40px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7); text-align: center; width: 350px;
        }
        h1 { margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #444;
            border-radius: 5px; background-color: #333;
            color: white; box-sizing: border-box; 
        }
        button {
            width: 100%; padding: 10px; border: none; border-radius: 5px;
            background-color: #007bff; color: white;
            font-size: 16px; cursor: pointer; transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .error-message { color: #ff4d4d; height: 20px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Criar Novo Personagem</h1>
        <form id="create-form">
            <div class="input-group">
                <label for="name">Nome do Personagem</label>
                <input type="text" id="name" name="name" required minlength="3" maxlength="20">
            </div>
            <div class="input-group">
                <label for="class">Classe</label>
                <select id="class-select" name="class" required>
                    <option value="">A carregar classes...</option>
                </select>
            </div>
            <button type="submit" id="create-button">Criar Personagem</button>
            <p id="error-message" class="error-message"></p>
        </form>
    </div>

    <script>
        const accountInfoString = sessionStorage.getItem('accountInfo');
        let accountInfo;

        if (!accountInfoString) {
            window.location.href = '/login.html';
        } else {
            accountInfo = JSON.parse(accountInfoString);
        }

        const createForm = document.getElementById('create-form');
        const nameInput = document.getElementById('name');
        const classSelect = document.getElementById('class-select');
        const createButton = document.getElementById('create-button');
        const errorMessage = document.getElementById('error-message');
        
        const socket = io('http://localhost:3000');

        // --- Eventos do Socket ---
        
        socket.on('connect', () => {
            console.log('Conectado ao servidor!');
            
            // --- A CORREÇÃO ESTÁ AQUI ---
            // Envia o ID da conta (guardado no login) para autenticar este socket
            if (accountInfo && accountInfo.accountId) {
                console.log(`Autenticando socket com accountId: ${accountInfo.accountId}`);
                socket.emit('client:authenticate', { accountId: accountInfo.accountId });
            } else {
                console.error('Não foi possível encontrar accountId no sessionStorage para autenticar.');
            }
            // --- FIM DA CORREÇÃO ---

            // Pede a lista de classes assim que conecta
            socket.emit('character:getClasses');
        });

        // 1. Recebe a lista de classes do servidor
        socket.on('character:classList', (classes) => {
            classSelect.innerHTML = ''; // Limpa o "A carregar..."
            if (classes && classes.length > 0) {
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    classSelect.appendChild(option);
                });
            } else {
                classSelect.innerHTML = '<option value="">Nenhuma classe disponível</option>';
            }
        });

        // 2. Ouve a falha na criação
        socket.on('character:createFail', (data) => {
            errorMessage.textContent = data.message;
            createButton.disabled = false;
        });

        // 3. Ouve o SUCESSO na criação (e a lista de personagens atualizada)
        socket.on('account:updateCharacters', (data) => {
            // 'data' é o novo objeto accountInfo (com a lista de personagens atualizada)
            console.log('Lista de personagens atualizada recebida.');
            sessionStorage.setItem('accountInfo', JSON.stringify(data));
            
            // Agora sim, redireciona de volta para a seleção
            window.location.href = 'character-select.html';
        });

        // --- Evento do Formulário ---
        
        createForm.addEventListener('submit', function(event) {
            event.preventDefault(); 

            const name = nameInput.value;
            const classId = classSelect.value;

            if (!classId) {
                errorMessage.textContent = 'Por favor, selecione uma classe.';
                return;
            }

            createButton.disabled = true;
            errorMessage.textContent = 'A criar...';

            socket.emit('character:createAttempt', {
                name: name,
                classId: parseInt(classId, 10) // Envia o ID da classe
            });
        });

    </script>
</body>
</html>